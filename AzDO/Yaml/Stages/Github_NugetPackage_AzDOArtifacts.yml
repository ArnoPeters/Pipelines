parameters:
- name: azureArtifactsFeed
- name: 'pool'
  type: object
  default: {}
- name: 'buildConfiguration'
  default: "Release"
  type: string
- name: 'rootBranchName'
  type: string
- name: 'runSettingsFile'
  type: string
- name: 'githubEndpoint'
  type: string


stages:
- stage: Build
  displayName: Build and Publish nuget package 
  pool: ${{ parameters.pool }}
  jobs:
  - job: Build
    workspace:
      clean: all
    steps:
    - checkout: self
      displayName: "Checkout repository including submodules"
      submodules: true
      persistCredentials: true

    - template: ..\Steps\ComputeGitVersion.yml
      parameters:
        gitVersionConfigFilePath: "GitVersion.yml"
        rootBranchName: ${{ parameters.rootBranchName }}
   
    - template: ..\Steps\BuildAndTest.yml
      parameters:
        azureArtifactsFeed: ${{ parameters.azureArtifactsFeed }}
        buildConfiguration: ${{ parameters.buildConfiguration }}
        runSettingsFile: ${{ parameters.runSettingsFile }}

    # https://marketplace.visualstudio.com/items?itemName=KriefMikael.githubtools
    - task: GitHubTag@1
      displayName: Versioning - Tag commit on release'
      inputs:
        githubEndpoint: '${{ parameters.githubEndpoint }}'
        repositoryName: '$(Build.Repository.Name)'
        tag: 'v$(Gitversion.MajorMinorPatch)'
      condition: eq('${{ variables['Build.SourceBranch'] }}', '${{ parameters.rootBranchName }}')

    - task: DotNetCoreCLI@2
      displayName: 'NuGet - Push package(s) to [${{ parameters.azureArtifactsFeed }}]'
      inputs:
        command: push
        packagesToPush: '$(System.DefaultWorkingDirectory)/src/**/*.nupkg'
        publishVstsFeed: '${{ parameters.azureArtifactsFeed }}'      
        
    - task: PublishSymbols@2
      displayName: 'Nuget - Publish symbols to artifacts'
      inputs:
        SearchPattern: '**/bin/**/*.pdb'
        IndexSources: false
        SymbolServerType: 'TeamServices'
