# Full workflow for creating a pipeline in Azure Devops to create nuget packages from an Azure Devops Git repo, to be published to Azure Devops Artifacts. 
# Features: 
#   - Pre-release on Pull Request
#   - Full release when a Pull Request is accepted and merged
#   - Gitversion is used for automatic semantic versioning
#   - Outputs debug symbols and uses Source Link to provide step-into-package-code during debugging
#
# Best used in combination with the template nuget package (TODO: link)
#
# Prerequisites: 
# The Project Collection Build Server ACCOUNT - not the GROUP needs the following permissions: 
# - Tag
# - Contribute
# These can be set by going to Manage Repositories -> All repositories -> Security
# Azure Devops Marketplace tasks required to use this template. 
# Please check them for further prerequisites and permission settings.
# - https://marketplace.visualstudio.com/items?itemName=gittools.gittools)

parameters:
- name: DependsOn
  type: object
  default: []
- name: azureArtifactsFeed
- name: rootBranchName
  type: string
- name: gitVersionConfigFilePath
  type: string  
  default: 'GitVersion.yml'
- name: pdbArtifactName
  type: string  
  default: 'PdbSymbols'
- name: pdbFilter
  type: string  
  default: '**/bin/**/*.pdb'
- name: steps
  type: stepList
  default: []
- name: workspace
  type: object
  default: {
    clean: all
  }
- name: buildJobName
  type: string  
  default: 'BuildPackage'

jobs:
- job: ${{ parameters.buildJobName }}
  displayName: Autoversion and build
  dependsOn: ${{ parameters.DependsOn }}
  condition: succeeded()
  workspace:
    ${{ parameters.workspace }}
  steps:
  - template: AzDO/Yaml/Steps/NugetPackage_AzDOArtifacts.yml@templates
    parameters:
      gitVersionConfigFilePath: ${{ parameters.gitVersionConfigFilePath }}
      rootBranchName: ${{ parameters.rootBranchName }}
      azureArtifactsFeed: ${{ parameters.azureArtifactsFeed }}
      pdbArtifactName: ${{ parameters.pdbArtifactName }}
      pdbFilter: ${{ parameters.pdbFilter }}
      steps: ${{ parameters.steps }}

- template: AzDO/Yaml/Jobs/PdbArtifact_Publish_Symbols_AzDO.yml@templates
  parameters:
    DependsOn: ${{ parameters.buildJobName }}
    pdbArtifactName: ${{ parameters.pdbArtifactName }}    
     