# Full workflow for creating a pipeline in Azure Devops to create nuget packages from an Azure Devops Git repo, to be published to Azure Devops Artifacts. 
# Features: 
#   - Pre-release on Pull Request
#   - Full release when a Pull Request is accepted and merged
#   - Gitversion is used for automatic semantic versioning
#   - Outputs debug symbols and uses Source Link to provide step-into-package-code during debugging
#
# Best used in combination with the template nuget package (TODO: link)
#
# Prerequisites: 
# The Project Collection Build Server ACCOUNT - (not the GROUP!) - needs the following permissions: 
# - Tag
# - Contribute
# These can be set by going to Manage Repositories -> All repositories -> Security
# Azure Devops Marketplace tasks required to use this template. 
# Please check them for further prerequisites and permission settings.
# - https://marketplace.visualstudio.com/items?itemName=gittools.gittools)

parameters:
- name: azureArtifactsFeed
- name: buildSteps
  type: stepList
- name: dependsOn
  type: object
  default: []
- name: rootBranchName
  type: string
  default: 'refs/heads/main'
- name: gitVersionConfigFilePath
  type: string  
  default: 'GitVersion.yml'
- name: pdbArtifactName
  type: string  
  default: 'PdbSymbols'
- name: pdbFilter
  type: string  
  default: '**/bin/**/*.pdb'
- name: workspace
  type: object
  default: {
    clean: all
  }
- name: buildJobName
  type: string  
  default: 'BuildPackage'
- name: windowsPool
  type: object
  default: {
    vmImage: 'windows-latest'
  }

jobs:
- template: NugetPackage_AzDOArtifacts.yml@templates
  parameters:
    buildJobName: ${{ parameters.buildJobName }}
    dependsOn: ${{ parameters.dependsOn }}
    workspace:
      ${{ parameters.workspace }}
    gitVersionConfigFilePath: ${{ parameters.gitVersionConfigFilePath }}
    rootBranchName: ${{ parameters.rootBranchName }}
    azureArtifactsFeed: ${{ parameters.azureArtifactsFeed }}
    pdbArtifactName: ${{ parameters.pdbArtifactName }}
    pdbFilter: ${{ parameters.pdbFilter }}
    buildSteps: ${{ parameters.buildSteps }}

- template: PdbArtifact_Publish_Symbols_AzDOArtifacts.yml@templates
  parameters:
    dependsOn: ${{ parameters.buildJobName }}
    pdbArtifactName: ${{ parameters.pdbArtifactName }}    
    pool: ${{ parameters.windowsPool }}    