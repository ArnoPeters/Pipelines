parameters:
- name: 'Subscription'
  type: string
- name: 'ResourceGroupName'
  type: string
  default: ''
- name: 'ResourceLocation'
  type: string
  default: ''
- name: 'TemplateFile'
  type: string
- name: 'TemplateParameterFile'
  type: string
- name: 'ParameterOverrides'
  type: string
  default: ''
- name: 'OutputVariableNamePrefix'
  type: string
  default: ''
- name: 'deploymentName'
  type: string
  default: ''

steps:

# Based on the script found on https://blog.johnnyreilly.com/2021/03/20/bicep-meet-azure-pipelines/
# While awaiting official microsoft pipeline task https://github.com/Azure/bicep/issues/1341
- task: AzureCLI@2
  displayName: 'Bicep: Template deployment'
  inputs:
    azureSubscription: '${{ parameters.Subscription }}'
    failOnStandardError: true
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      deploymentName=${{ parameters.deploymentName }}
      templateParameterFile=${{ parameters.TemplateParameterFile }}
      parameterOverrides=${{ parameters.ParameterOverrides }}
      resourceGroupName=${{ parameters.ResourceGroupName }}
      resourceLocation=${{ parameters.ResourceLocation }}
      templateFile=${{ parameters.TemplateFile }}
      outputVariableNamePrefix=${{ parameters.OutputVariableNamePrefix }}

      if [ "$deploymentName" == "" ]; then 
        deploymentName="deploy-$(date +%Y%m%d-%H%M%S)"
      fi

      params=""
      if [ "$parameterOverrides" != "" ]; then 
        params+=" --parameters $parameterOverrides"
      fi
      if [ "$templateParameterFile" != "" ]; then 
        params+=" --parameters @$templateParameterFile"
      fi
      
      if [ "$resourceGroupName" == "" ]; then
        az deployment sub create \
          --name $deploymentName \
          --location $resourceLocation \
          --template-file $templateFile \
          $params

          echo "az deployment sub show --name $deploymentName"
          deploymentoutputs=$(az deployment sub show --name $deploymentName \
            --query properties.outputs)
      elif [ "$resourceLocation" == "" ]; then

        az deployment group create \
          --name $deploymentName \
          --resource-group $resourceGroupName \
          --template-file $templateFile \
          $params

          echo "az deployment group show --resource-group $resourceGroupName --name $deploymentName"
          deploymentoutputs=$(az deployment group show --resource-group $resourceGroupName --name $deploymentName \
            --query properties.outputs)
      else
        echo "Specify either ResourceGroup or ResourceLocation."
        exit 1
      fi

      echo 'convert outputs to variables'
      echo $deploymentoutputs | jq -c '. | to_entries[] | [.key, .value.value, .value.type]' |
        while IFS=$"\n" read -r c; do
          keyname=$(echo "$c" | jq -r '.[0]')
          value=$(echo "$c" | jq -r '.[1]')
          type=$(echo "$c" | jq -r '.[2]')
          
          if [ "$type" == "SecureString" ]; then
            echo "##vso[task.setvariable variable=$outputVariableNamePrefix$keyname;issecret=true]$value"
            echo "Added variable '$keyname' ('$type')"
          elif [ "$type" == "String" ]; then 
            echo "##vso[task.setvariable variable=$outputVariableNamePrefix$keyname]$value"
            echo "Added variable '$keyname' ('$type') with value '$value'"
          else 
            echo "Skipped output variable conversion: Type '$type' is not supported for '$keyname'"
          fi
          
        done
