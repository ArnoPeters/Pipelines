parameters:
- name: 'ArmOutputJson'
  type: string
- name: 'Prefix'
  type: string
  default: ''
  
steps:
    #https://www.timmerman.it/index.php/using-values-from-your-arm-template-across-your-azure-devops-pipeline-with-powershell/
    - powershell: |
        $outputs = '${{ parameters.ArmOutputJson }}' | ConvertFrom-Json
        $outputs.PSObject.Properties | ForEach-Object {
          $type = ($_.value.type).ToLower()
          $keyname = $_.name 
          $value = $_.value.value

          if ($type -eq "securestring") {
            $var = '##vso[task.setvariable variable={0};issecret=true]{1};isOutput=true;' -f $keyname, $value
            Write-Output $var
            Write-Output "Added output variable '${{ parameters.Prefix }}ArmOutputVariables.$keyname' ('$type')"
          } elseif ($type -eq "string") {
            $var = '##vso[task.setvariable variable={0}]{1};isOutput=true;' -f $keyname, $value
            Write-Output $var
            Write-Output "Added output variable '${{ parameters.Prefix }}ArmOutputVariables.$keyname' ('$type') with value '$value'"
          } else {
            Write-Output "Skipped conversion: Type '$type' is not supported for '$keyname'"
          }
        }
      name: '${{ parameters.Prefix }}ArmOutputVariables'
      displayName: 'Expose ARM output variables'