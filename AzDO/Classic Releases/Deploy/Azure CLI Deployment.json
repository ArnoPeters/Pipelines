{
    "tasks": [
        {
            "environment": {},
            "displayName": "Azure CLI - Deployment to Azure",
            "alwaysRun": false,
            "continueOnError": false,
            "condition": "succeeded()",
            "enabled": true,
            "timeoutInMinutes": 0,
            "retryCountOnTaskFailure": 0,
            "inputs": {
                "connectedServiceNameARM": "$(subscription)",
                "scriptType": "bash",
                "scriptLocation": "inlineScript",
                "scriptPath": "",
                "inlineScript": "      deploymentName='$(deploymentName)'\n      templateParameterFile='$(templateParameterFile)'\n      parameterOverrides=\"$(parameterOverrides)\"\n      resourceGroupName='$(resourcegroupName)'\n      resourceLocation='$(resourceLocation)'\n      templateFile='$(templateFile)'\n      outputVariableNamePrefix='$(outputVariableNamePrefix)'\n\n      if [ \"$deploymentName\" == \"\" ]; then \n        deploymentName=\"$(date +%Y%m%d-%H%M%S)-deployment\"\n      fi\n\n      params=\"\"\n      if [ \"$parameterOverrides\" != \"\" ]; then \n        params+=\" --parameters $parameterOverrides\"\n      fi\n      if [ \"$templateParameterFile\" != \"\" ]; then \n        params+=\" --parameters @$templateParameterFile\"\n      fi\n      \n      if [ \"$resourceGroupName\" == \"\" ]; then\n        az deployment sub create \\\n          --name $deploymentName \\\n          --location $resourceLocation \\\n          --template-file $templateFile \\\n          $params\n\n          echo \"az deployment sub show --name $deploymentName\"\n          deploymentoutputs=$(az deployment sub show --name $deploymentName \\\n            --query properties.outputs)\n      elif [ \"$resourceLocation\" == \"\" ]; then\n\n        az deployment group create \\\n          --name $deploymentName \\\n          --resource-group $resourceGroupName \\\n          --template-file $templateFile \\\n          $params\n\n          echo \"az deployment group show --resource-group $resourceGroupName --name $deploymentName\"\n          deploymentoutputs=$(az deployment group show --resource-group $resourceGroupName --name $deploymentName \\\n            --query properties.outputs)\n      else\n        echo \"Specify either ResourceGroup or ResourceLocation.\"\n        exit 1\n      fi\n\n      echo 'convert outputs to variables'\n      echo $deploymentoutputs | jq -c '. | to_entries[] | [.key, .value.value, .value.type]' |\n        while IFS=$\"\\n\" read -r c; do\n          keyname=$(echo \"$c\" | jq -r '.[0]')\n          value=$(echo \"$c\" | jq -r '.[1]')\n          type=$(echo \"$c\" | jq -r '.[2]')\n          \n          if [ \"$type\" == \"SecureString\" ]; then\n            echo \"##vso[task.setvariable variable=$outputVariableNamePrefix$keyname;issecret=true]$value\"\n            echo \"Added variable '$keyname' ('$type')\"\n          elif [ \"$type\" == \"String\" ]; then \n            echo \"##vso[task.setvariable variable=$outputVariableNamePrefix$keyname]$value\"\n            echo \"Added variable '$keyname' ('$type') with value '$value'\"\n          else \n            echo \"Skipped output variable conversion: Type '$type' is not supported for '$keyname'\"\n          fi\n          \n        done",
                "scriptArguments": "",
                "powerShellErrorActionPreference": "stop",
                "addSpnToEnvironment": "false",
                "useGlobalConfig": "false",
                "cwd": "",
                "failOnStandardError": "true",
                "powerShellIgnoreLASTEXITCODE": "false"
            },
            "task": {
                "id": "46e4be58-730b-4389-8a2f-ea10b3e5e815",
                "versionSpec": "2.*",
                "definitionType": "task"
            }
        }
    ],
    "runsOn": [
        "Agent",
        "DeploymentGroup"
    ],
    "revision": 3,
    "createdBy": {
        "displayName": "Arno Peters",
        "id": "6b7b6d39-61fa-4959-bf89-b8d308844343",
        "uniqueName": "arnop@4dotnet.nl"
    },
    "createdOn": "2022-01-14T15:02:46.187Z",
    "modifiedBy": {
        "displayName": "Arno Peters",
        "id": "6b7b6d39-61fa-4959-bf89-b8d308844343",
        "uniqueName": "arnop@4dotnet.nl"
    },
    "modifiedOn": "2022-11-11T12:47:50.517Z",
    "comment": "",
    "id": "65ea90a9-84f9-412d-954d-8b03f5f01ffc",
    "name": "Azure CLI Deployment",
    "version": {
        "major": 1,
        "minor": 0,
        "patch": 0,
        "isTest": false
    },
    "iconUrl": "https://cdn.vsassets.io/v/M197_20220105.3/_content/icon-meta-task.png",
    "friendlyName": "Azure CLI Deployment",
    "description": "Wrapper around Azure CLI to simplify deploying an ARM or a BICEP template to a resource group. ",
    "category": "Deploy",
    "definitionType": "metaTask",
    "author": "Arno Peters",
    "demands": [],
    "groups": [],
    "inputs": [
        {
            "aliases": [],
            "options": {
                "Subscription": "Subscription",
                "ResourceGroup": "Resource group"
            },
            "properties": {
                "EditableOptions": "False"
            },
            "name": "DeploymentLevel",
            "label": "Deployment level",
            "defaultValue": "ResourceGroup",
            "required": true,
            "type": "pickList",
            "helpMarkDown": "Deployment level of the template in Azure"
        },
        {
            "aliases": [],
            "options": {
                "incremental": "Incremental",
                "complete": "Complete"
            },
            "properties": {
                "EditableOptions": "False"
            },
            "name": "Mode",
            "label": "Deployment Mode",
            "defaultValue": "incremental",
            "required": true,
            "type": "pickList",
            "helpMarkDown": "Deployment mode of the template in Azure"
        },
        {
            "aliases": [],
            "options": {},
            "properties": {},
            "name": "parameterOverrides",
            "label": "Parameter overrides",
            "defaultValue": "deploymentContainerUri='$(deploymentBlobContainerUri)$(Build.SourceBranchName)/$(Build.BuildNumber)' deploymentContainerSasToken='$(deploymentBlobContainerSasToken)' environment='$(environment)' ownerTeam='$(ownerTeam)'",
            "required": true,
            "type": "string",
            "helpMarkDown": "key1=value1 key2=value2",
            "groupName": ""
        },
        {
            "aliases": [],
            "options": {},
            "properties": {},
            "name": "resourceGroupName",
            "label": "Resource group Name",
            "defaultValue": "",
            "required": true,
            "type": "string",
            "helpMarkDown": "Name of the resource group to be used in Azure",
            "groupName": "",
            "visibleRule": "DeploymentLevel = ResourceGroup"
        },
        {
            "aliases": [],
            "options": {},
            "properties": {},
            "name": "resourceLocation",
            "label": "Resource location",
            "defaultValue": "",
            "required": true,
            "type": "string",
            "helpMarkDown": "Azure location of the resources",
            "groupName": "",
            "visibleRule": "DeploymentLevel = Subscription"
        },
        {
            "aliases": [],
            "options": {},
            "properties": {
                "EndpointFilterRule": ""
            },
            "name": "subscription",
            "label": "Subscription",
            "defaultValue": "$(subscription)",
            "required": true,
            "type": "connectedService:AzureRM",
            "helpMarkDown": "Select an Azure Resource Manager service connection for the deployment",
            "groupName": ""
        },
        {
            "aliases": [],
            "options": {},
            "properties": {},
            "name": "templateFile",
            "label": "Template file",
            "defaultValue": "",
            "required": true,
            "type": "string",
            "helpMarkDown": "Full path to the template file",
            "groupName": ""
        },
        {
            "aliases": [],
            "options": {},
            "properties": {},
            "name": "templateParameterFile",
            "label": "Template parameter file",
            "defaultValue": "",
            "required": false,
            "type": "string",
            "helpMarkDown": "Full path to the template parameter file",
            "groupName": ""
        },
        {
            "aliases": [],
            "options": {},
            "properties": {},
            "name": "deploymentName",
            "label": "Deployment Name",
            "defaultValue": "",
            "required": false,
            "type": "string",
            "helpMarkDown": "Name of the deployment as it is to be shown in Azure. Leave blank to generate a timestamped name.",
            "groupName": ""
        },
        {
            "aliases": [],
            "options": {},
            "properties": {},
            "name": "outputVariableNamePrefix",
            "label": "Output Variable Name Prefix",
            "defaultValue": "",
            "required": false,
            "type": "string",
            "helpMarkDown": "Use to distinguish output variable groups if multiple Azure Deployments are used in the same release.",
            "groupName": ""
        }
    ],
    "satisfies": [],
    "sourceDefinitions": [],
    "dataSourceBindings": [],
    "instanceNameFormat": "Task group: Azure CLI Deployment to Resource group $(resourceGroupName)",
    "preJobExecution": {},
    "execution": {},
    "postJobExecution": {}
}